# 処理フロー (Process Flow)

## 1. アプリケーション起動
- `wuwacalc17.py`: メインエントリーポイント。
- `DataManager`: `data/game_data.json`, `data/calculation_config.json` を読み込み。
- `CharacterManager`: `character_settings_jsons/*.json` からキャラクター毎の重み、メインステータス、クリティカル補正を読み込み。
- `ConfigManager`: アプリケーションの設定（言語、テーマ、OCR設定など）を管理。

## 2. 画像読み込みと前処理
- クリップボード(Ctrl+V)またはファイルから画像を読み込み。
- `ImageProcessor`: 設定された切り取り範囲（Crop）に基づいて画像をトリミング。
- `image_preprocessing.py`: 二値化、グレースケール化、リサイズなどの前処理を行い、OCR精度を向上。

## 3. OCRによるデータ抽出
- Tesseract OCRを使用。
- `detect_metadata.py`: 抽出されたテキストから、コスト、メインステータス、サブステータスを正規表現とエイリアスマップを用いて特定。
- 認識されたデータは UI（`TabManager`）に自動入力される。

## 4. スコア計算ロジック (コア部分)
- `ScoreCalculator` が UI からデータを受け取り、`EchoData` に渡す。
- **期待値ベースの評価 (厳選達成率)**:
  1. キャラクターの重み設定から上位5つの項目を抽出。
  2. それらすべてが最大値（Max Roll）だった場合を理論値（100%）として算出。
  3. 現在のサブステータスの合計を理論値で割り、達成率を算出。
- **最終ステータス・目標達成度の算出**:
  - キャラクターの基礎ステータス（本体+武器）と理想ステータスを考慮。
  - `(基礎値 * (1 + %補正合計/100)) + 固定値補正合計` により最終ステータスを推定。
  - 理想ステータスに対して、この音骸を装備した状態で何%に到達するかを表示。
- **CV計算 (Crit Value)**:
  - `(会心率 * 2) + 会心ダメージ` に加え、攻撃力%やチャージ効率などを加味。
  - キャラクター設定の「クリ補正」を考慮した評価判定。
- **コスト別Rating調整**:
  - コスト3など厳選が困難な部位については、SSS/SS判定の閾値を緩和し、ユーザーのモチベーションを維持。

## 5. 結果表示と保存
- `HtmlRenderer`: 計算結果を HTML 形式で整形し、UIの右側に表示。
- `HistoryManager`: 計算結果を `history.json` に保存。重複検知機能により、同じ音骸の再計算を整理。

---

# 既知の課題と改善案

## 改善済み (2025-12-25)
- [x] スコア計算を単純加算から「理想個体に対する達成率（%）」に変更。
- [x] コストごとの厳選難易度を Rating 閾値に反映。
- [x] 武器や基礎ステータスを考慮できる「クリティカル補正」フィールドをキャラ設定に追加。

## 今後の課題
- [ ] OCRの誤認（「0」と「O」など）に対する、音骸のステータス範囲（Max/Min）を用いたバリデーションの強化。
- [ ] 履歴画面での音骸同士の直接比較機能。
- [ ] ダークモード時の HTML 表示（結果画面）の色の視認性向上。
