# プログラム処理フロー

## 1. アプリケーション起動
- `wuwacalc17.py`: エントリーポイント。`ScoreCalculatorApp` クラスがメインウィンドウとして動作。
- `core/app_setup.py`: `AppContext` を介して、依存関係のある全てのマネージャーとコアロジックを一括初期化。
- `ui/ui_components.py`: PySide6 を用いたメインレイアウトの構築。
- `ui/event_handlers.py`: ユーザー操作や各種シグナル（OCR完了、計算要求等）に対する全イベント制御を集約。

## 2. 画像読み込みと解析 (OCR)
- **取得**: クリップボード監視またはファイル選択（`EventHandlers.import_image`）により画像を取得。
- **前処理**: `core/image_processor.py` でグレースケール化、適応的二値化、リサイズを実施。
- **非同期実行**: `core/worker_thread.py (OCRWorker)` がバックグラウンドで Tesseract を実行。
- **解析**: `core/ocr_parser.py` が正規表現を用いてステータス名と数値を抽出。
- **反映**: `ui/event_handlers.py (_apply_ocr_result)` が、コストやステータスから最適なタブを自動判別して解析結果を流し込む。

## 3. スコア計算と評価ロジック
- **計算エンジン**: `core/score_calculator.py` がマネージャーから取得した重みデータを用いて計算を実行。
- **評価アルゴリズム**: `core/echo_data.py` が以下の5つの手法で評価を実施：
    1. 正規化スコア (Normalized)
    2. 重要度比率 (Ratio)
    3. ロール品質 (Roll Quality)
    4. 有効ステータス数 (Effective Count)
    5. クリティカル価値 (CV-based)
- **比較機能**: 現在の「装備中」エコーとのスコア差分（Comparison Diff）をリアルタイムに算出。

## 4. UIレンダリングと表示
- **HTML生成**: `ui/html_renderer.py` が CSS スタイルを含む計算結果の HTML を生成。
- **動的リフレッシュ**: `wuwacalc17.py (refresh_results_display)` が、設定変更（色、フォント、影）を既存の表示結果に即座に反映。
- **テーマ管理**: `managers/theme_manager.py` がアプリ全体の配色や背景透過度を制御。

## 5. ビルド共有（スコアボード）
- **画像生成**: `core/scoreboard_generator.py` が 5 つのエコー情報を統合した build 紹介画像を生成。
- **最適化**: フォントキャッシュによる高速描画。
- **動的テーマ**: キャラクターの属性（焦熱、凝縮、回折、消滅、電導、気動）を判別し、背景とアクセントカラーを自動設定。

# 現在の状況と改善点

## 1. 堅牢性の向上 (完了)
- **バリデーション**: `score_calculator.py` で数値変換時の異常値（NaN/Inf）や不正文字列を事前に排除。
- **安全なプロパティ**: `DataManager` の各プロパティにデフォルト値と型チェックを追加し、JSON破損によるクラッシュを防止。

## 2. コード品質と保守性 (大幅改善)
- **PEP 8 準拠**: 主要な全ファイルにおいてインポート順序、docstring、命名規則、空行の配置を修正。
- **スパゲッティコードの解消**: 
    - メインウィンドウに混在していた表示更新ロジックを `HtmlRenderer` へ委譲。
    - `EventHandlers` 内の重複していた OCR 適用処理を `_apply_ocr_result` に統一。
- **安全性**: `GEMINI.md` に「変更後の自動構文チェック」ルールを追加。

## 3. 今後の課題
- **データ更新の自動化**: 新キャラクター追加時に手動で JSON を編集する手間を減らすための、マスターデータからの自動生成機能。
- **UI/UX**: 複数エコーをまとめて「一括装備登録」する機能。
- **計算ロジック**: セット効果（属性ダメージアップ等）を含めたトータルステータスのシミュレーション。
