# アプリケーション処理フローと改善点分析

このドキュメントは、[`wuwacalc17.py`](./wuwacalc17.py) を中心とした Wuthering Waves Echo Score Calculator の処理フロー、設計方針、改善点を記述します。

## 1. アプリケーション構成と責務分離

| コンポーネント | 責務 |
| :--- | :--- |
| **[`wuwacalc17.py`](./wuwacalc17.py)** | エントリーポイント。各マネージャーの初期化とシグナルの仲介（Mediator）。 |
| **`DataManager`** | ゲームデータ（ステータス名、エイリアス等）のロードと検証。 |
| **`ConfigManager`** | アプリケーション設定（`config.json`）の永続化。 |
| **`CharacterManager`** | キャラクターごとの重み付け設定の管理。 |
| **`TabManager`** | タブの動的生成、データの抽出・復元、OCR結果のUI反映。 |
| **`UIComponents`** | UIレイアウトの構築。 |
| **`EventHandlers`** | UIイベントの制御とマネージャー間の連携。 |
| **`ImageProcessor`** | 画像の読み込み、クロップ、OCR Worker の管理。 |
| **`ScoreCalculator`** | スコア計算の実行。履歴追加時の重複挙動制御。 |
| **`HistoryManager`** | 計算履歴の保存・検索・フィルタリング。重複検知（Fingerprint）の実装。 |
| **`ThemeManager`** | テーマ、フォント、背景画像、透明度の制御。 |
| **`DataContracts`** | クラス間を流れるデータの型定義。 |

## 2. 主要な処理フロー

### 2.1 起動フロー
1. `ScoreCalculatorApp` が起動し、各マネージャーを初期化。
2. `ConfigManager` から `history_duplicate_mode` 等の設定をロード。
3. `UIComponents` が UI を構築。

### 2.2 画像処理・OCRフロー
1. 画像インポート後、設定に基づき自動クロップと OCR を実行。
2. 結果を `TabManager` 経由で各タブの入力欄に反映。

### 2.3 スコア計算・履歴保存フロー
1. `ScoreCalculator` がタブデータを抽出し、スコアを算出。
2. **重複チェック**: 音骸ステータスから生成した `fingerprint` を使用。
3. **履歴追加**: `history_duplicate_mode` に基づき以下の処理を行う。
    - `all`: すべて保存（重複を許容）。
    - `latest`: 古い重複エントリを削除して最新を保存。
    - `oldest`: 既に存在する場合は新規保存をスキップ（最古の時刻を維持）。
4. 結果を HTML で表示。

### 2.4 履歴検索・フィルタリング
1. `HistoryDialog` でキーワード、キャラクター、コスト、**評価（SSS~C）**、日付による絞り込みが可能。
2. 評価フィルタは正規表現を用い、「S」と「SS」などを正確に区別してマッチング。

## 3. 完了済みの主要タスク

- **高度な履歴管理機能**:
    - 重複データの扱い（最新保持/最古保持/すべて保存）を選択可能に。
    - 設定を履歴ダイアログ内に集約し、直感的な操作を実現。
    - 評価ランクによる正確なフィルタリング機能の実装。
- **アーキテクチャの刷新**: 各マネージャーへの責務分散。
- **UI/UX の強化**: 自動計算、テーマカスタマイズ、ショートカット等。

## 4. 現在の課題とネクストアクション

### ロジック・構造面
1.  **エイリアスマッチングの整理**: `DataManager` へのロジック移譲。
2.  **OCR 適合率の向上**: 特定の数値誤認に対するポストプロセスの強化。

### UI/UX 面
1.  **一括計算・一括保存**: OCR バッチ処理結果の効率的な管理。
2.  **履歴統計の可視化**: スコア推移のグラフ表示など。

## 5. メンテナンスツール
- **[`doc_linker.py`](./tools/doc_linker.py)**: ドキュメント内のリンク自動生成。
