# アプリケーション処理フローと改善点分析

このドキュメントは、[`wuwacalc17.py`](./wuwacalc17.py) を中心とした Wuthering Waves Echo Score Calculator の処理フロー、設計方針、改善点を記述します。

## 1. アプリケーション構成と責務分離

| コンポーネント | 責務 |
| :--- | :--- |
| **[`wuwacalc17.py`](./wuwacalc17.py)** | エントリーポイント。各マネージャーの初期化とシグナルの仲介（Mediator）。 |
| **`DataManager`** | ゲームデータ（ステータス名、エイリアス等）のロードと検証。 |
| **`ConfigManager`** | アプリケーション設定（`config.json`）の永続化。 |
| **`CharacterManager`** | キャラクターごとの重み付け設定の管理。 |
| **`TabManager`** | タブの動的生成、データの抽出・復元、OCR結果のUI反映。 |
| **`UIComponents`** | UIレイアウトの構築。ロジックを持たず、ウィジェット生成に専念。 |
| **`EventHandlers`** | UIイベントの制御とマネージャー間の連携。 |
| **`ImageProcessor`** | 画像の読み込み、クロップ、OCR Worker の管理。 |
| **`ScoreCalculator`** | スコア計算の実行。履歴追加時の重複挙動（all/latest/oldest）の制御。 |
| **`HistoryManager`** | 計算履歴の保存・検索・フィルタリング。`fingerprint` による同一性判定。 |
| **`ThemeManager`** | テーマ、フォント、背景画像、透明度の制御。 |
| **`DataContracts`** | クラス間を流れるデータの型定義（`HistoryEntry`, `EchoEntry` 等）。 |

## 2. 主要な処理フロー

### 2.1 起動フロー
1. `ScoreCalculatorApp` が起動し、各マネージャーを初期化。
2. `ConfigManager` から前回終了時の設定（言語、テーマ、**履歴重複モード**等）をロード。
3. `UIComponents` が UI を構築し、`EventHandlers` がシグナルを接続。

### 2.2 画像処理・OCRフロー
1. `ImageProcessor` が画像を取得し、設定（％指定など）に基づき自動クロップを適用。
2. `WorkerThread` がバックグラウンドで OCR を実行。
3. 結果を `TabManager` 経由で各タブに反映し、必要に応じて自動計算を実行。

### 2.3 スコア計算・履歴保存フロー
1. `ScoreCalculator` がデータを抽出し、スコアを算出。
2. **重複チェック**: 音骸のコスト、メイン、全サブステータスから `fingerprint` (MD5) を生成。
3. **履歴追加**: `history_duplicate_mode` に基づき処理（`constants.py` の定数を使用）。
    - `all`: 重複を許容して新規保存。
    - `latest`: 既存の同一 fingerprint エントリを削除してから新規保存（最新化）。
    - `oldest`: 既に存在する場合は保存をスキップ（最初に計算した時刻を維持）。
4. 結果を `HtmlRenderer` で整形して表示。

### 2.4 履歴検索・設定
1. `HistoryDialog` では以下のフィルタリングが可能。
    - キーワード（アクション、結果、キャラ名）、キャラクター別、コスト別。
    - **評価ランク（SSS~C）**: 正規表現により「S」と「SS」を厳密に区別。
    - 日付範囲（カレンダー選択）。
2. **設定の一元化**: 履歴の重複挙動設定は、履歴ダイアログ下部のコンボボックスから直接変更・保存可能。

## 3. 完了済みの主要タスク（直近の改善・バグ修正）

- **バグ修正**:
    - **OCR多言語対応の不具合**: 言語設定に関わらず常に日本語OCRが実行される問題を修正（`app_logic.py`）。
    - **クロップ設定UIの不具合**: 幅（Width）の数値を変更した際に、誤って左位置（Left）のスライダーも連動してしまう問題を修正（`event_handlers.py`）。
    - **リサイズ時のクラッシュ要因**: ウィンドウリサイズ時のプレビュー更新で、存在しない属性を参照していた問題を修正（`event_handlers.py`）。
    - **計算方法設定のクラッシュ要因**: チェックボックスのインスタンスが誤って `app` インスタンスに保持されていたため、イベントハンドラからのアクセス時にエラーになる問題を修正（`ui_components.py`）。
- **リファクタリングとテスト**:
    - **UIコンポーネントの構造化**: 巨大化していた `UIComponents` クラスから設定関連のUIロジックを `SettingsPanel` クラスに分離し、保守性と可読性を向上（`ui_components.py`）。
    - **UIテストの追加**: 新規作成した `SettingsPanel` を含むUIコンポーネントの初期化と連携を検証する `test_ui_components.py` を追加し、カバレッジを拡大。
    - **計算ロジックの共通化**: `score_calculator.py` 内で重複していた計算・履歴保存ロジック（Single/Batch）を共通メソッド `_process_echo_evaluation` に統合し、保守性を向上。
    - **計算ロジックのテスト**: `test_score_calculator.py` を新規作成し、共通化されたロジックの動作検証を追加。
    - **その他コンポーネントの共通化**:
        - `image_processor.py`: 空きタブ検索ロジックを `_find_free_tab` に統合。
        - `tab_manager.py`: タブ内容のクリア処理を `_reset_tab_content` に統合。
- **高度な履歴管理**:
    - 重複データの3つのモード（Keep All / Latest / Oldest）の実装。
    - 評価ランクによる正確な検索機能（単語境界を考慮した正規表現マッチング）。
    - 履歴設定を履歴ダイアログに集約し、UI/UXを向上。
- **リファクタリング**:
    - 履歴アクション名（Single/Batch/OCR）の定数化による堅牢性の向上。
    - 検索エンジンの最適化（正規表現の整理）。
- **既存の機能強化**: 自動計算、テーマカスタマイズ、多言語対応の深化。

## 4. 現在の課題とネクストアクション

### ロジック・構造面
1.  **エイリアスマッチングの整理**: `DataManager` へのロジック移譲。
2.  **OCR 適合率の向上**: 数値誤認に対するポストプロセスの強化。

### UI/UX 面
1.  **一括計算結果の永続化**: バッチ処理結果の効率的な管理。
2.  **履歴統計の可視化**: スコア推移グラフなどの追加。

## 5. メンテナンスツール
- **[`doc_linker.py`](./tools/doc_linker.py)**: ドキュメント内のファイルリンク自動生成。